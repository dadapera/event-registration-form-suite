<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Modulo Iscrizione</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css"/>
  <style>
    .iti { display: block; } /* Make the library's container a block element */
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-4xl mx-auto p-6 bg-white shadow-md mt-10 rounded-lg">
    <!-- Logos Section -->
    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 sm:gap-6 lg:gap-8 mb-6">
      <img src="assets/mae-logo.png" alt="Mae Logo" class="h-10 sm:h-12 lg:h-16 w-auto object-contain max-w-24 sm:max-w-32 lg:max-w-none">
      <img src="assets/lafenice-logo.jpg" alt="La Fenice Logo" class="h-10 sm:h-12 lg:h-16 w-auto object-contain max-w-24 sm:max-w-32 lg:max-w-none">
    </div>
    
    <h1 class="text-3xl font-bold text-center mb-4" id="event-title">Evento</h1>
    <h2 class="text-2xl font-bold text-center mb-4" id="event-location">Location</h2>
    <p class="text-center mb-6" id="event-dates">Date</p>
   
   
    <!-- Divider -->
    <hr class="border-gray-300 my-6"> 
    <!-- Information Section -->
    <div class="text-left mb-6">
      <h3 class="text-xl font-semibold mb-3">Modulo di Iscrizione</h3>
      <p class="text-gray-700">Per procedere alla prenotazione è necessario compilare il modulo entro il <strong><span id="deadline-date"></span></strong> ponendo estrema attenzione alla correttezza dei dati inseriti.</p>
      <p class="text-sm text-red-600 mb-2">I campi contrassegnati con * sono obbligatori</p>
    </div>
    <!-- Divider -->
    <hr class="border-gray-300 my-6">

    <form id="registrationForm" class="space-y-6">
      <!-- Agente di Riferimento Section -->
      <section>
        <h2 class="text-xl font-semibold mb-2">Agente di Riferimento</h2>
        <div>
          <label class="block mb-0.5 font-medium text-sm">Selezionare Agente di Riferimento *</label>
          <select name="agente_riferimento" id="agente_riferimento" class="w-50 border border-gray-300 py-1 px-2 rounded text-sm" required>
            <option value="">-- Seleziona un agente --</option>
            <option value="AURELI MASSIMO">AURELI MASSIMO</option>
            <option value="CALVARESI LUCA">CALVARESI LUCA</option>
            <option value="CARMINUCCI FEDERICO">CARMINUCCI FEDERICO</option>
            <option value="COCCIA MASSIMILIANO">COCCIA MASSIMILIANO</option>
            <option value="DE CANNAS MARCO">DE CANNAS MARCO</option>
            <option value="DI BIAGIO GIANLUCA">DI BIAGIO GIANLUCA</option>
            <option value="DI LORENZO FEDERICO">DI LORENZO FEDERICO</option>
            <option value="FORTI ANDREA">FORTI ANDREA</option>
            <option value="ISOPI GIACOMO">ISOPI GIACOMO</option>
            <option value="MASSI VINCENZO">MASSI VINCENZO</option>
            <option value="PERLETTA FERDINANDO">PERLETTA FERDINANDO</option>
            <option value="PULCINI GIANNI">PULCINI GIANNI</option>
            <option value="DI FILIPPO GIANLUCA">DI FILIPPO GIANLUCA</option>
            <option value="GABRIELLI EMANUELE">GABRIELLI EMANUELE</option>
          </select>
        </div>
      </section>
      <!-- Divider -->
      <hr class="border-gray-300 my-6">
      <section>
        <h2 class="text-xl font-semibold mb-2">Informazioni Personali - Partecipante</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-3">
          <div>
            <label class="block mb-0.5 font-medium text-sm">Nome *</label>
            <input type="text" name="nome" id="nome" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" required>
          </div>
          <div>
            <label class="block mb-0.5 font-medium text-sm">Cognome *</label>
            <input type="text" name="cognome" id="cognome" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" required>
          </div>
          <div>
            <label class="block mb-0.5 font-medium text-sm">Data di Nascita *</label>
            <input type="date" name="data_nascita" id="data_nascita" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" required onchange="calculateTotal()">
          </div>

          <div>
            <label class="block mb-0.5 font-medium text-sm">Luogo di Nascita *</label>
            <input type="text" name="luogo_nascita" id="luogo_nascita" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" required>
          </div>
          <div>
            <label class="block mb-0.5 font-medium text-sm">Cittadinanza *</label>
            <input type="text" name="cittadinanza" id="cittadinanza" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" required value="Italiana">
          </div>
          <div>
            <label class="block mb-0.5 font-medium text-sm">Email *</label>
            <input type="email" name="email" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" required>
          </div>
          <div class="w-full">
            <label class="block mb-0.5 font-medium text-sm">Cellulare *</label>
            <input type="tel" name="cellulare" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" required pattern="[0-9]{9,10}" maxlength="10" title="Inserire un numero di 9-10 cifre" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
          </div>

          <!-- Contact Information Notice -->
          <div class="md:col-span-2">
            <p class="text-sm text-gray-600 italic">I recapiti forniti saranno utilizzati per tutte le comunicazioni inerenti al viaggio</p>
          </div>


          
          <!-- Dietary Requirements -->
          <div class="md:col-span-2 mt-4">
            <label class="block mb-0.5 font-medium text-sm">Esigenze Alimentari</label>
            <textarea name="esigenze_alimentari" id="esigenze_alimentari" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" rows="3" placeholder="Specificare eventuali allergie o intolleranze alimentari"></textarea>
            <div class="mt-2">
              <p class="text-sm text-gray-600 italic mb-1">Queste informazioni saranno utilizzate solo per garantire un servizio adeguato. *</p>
              <div class="flex items-center gap-4 text-sm">
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="consenso_dati_alimentari" id="consenso_dati_alimentari_si" value="si" class="h-4 w-4" checked>
                  <span>Acconsento al trattamento dei miei dati alimentari</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="consenso_dati_alimentari" id="consenso_dati_alimentari_no" value="no" class="h-4 w-4">
                  <span>Non acconsento</span>
                </label>
              </div>
              <div class="mt-2">
                <br/>
                <label class="inline-flex items-center text-sm">
                  <input type="checkbox" required class="form-checkbox mr-2">
                  Dichiaro di aver letto e compreso l'<span class="text-blue-600 hover:text-blue-800 underline cursor-pointer" onclick="document.getElementById('privacy-modal').classList.remove('hidden')">informativa</span> *
                </label>
              </div>
            </div>
          </div>
        </div>
      </section>



      <section>
        <hr class="my-4 border-gray-300">
        <h2 class="text-xl font-semibold mb-4">Gestione Ospiti</h2>
      </section>

      <!-- Dynamic Companions Section for Room 1 -->
      <section id="companionsSectionRoom1" class="mt-2">
        <h3 class="text-lg font-semibold mb-3 sr-only">Dati Ospite</h3> 
        <div id="companionFieldsRoom1"></div>
        <div class="mt-4">
            <button type="button" id="addCompanionRoom1Button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded text-sm w-full md:w-auto">
              Aggiungi Ospite
            </button>
            <span id="room1MaxReachedText" class="text-sm text-red-500 hidden">Numero massimo di ospiti raggiunto</span>
        </div>
      </section>



      <hr class="my-6 border-gray-300">

      <!-- Billing Section -->
      <section class="bg-yellow-50 p-3 rounded-lg">
        <h2 class="text-xl font-semibold mb-3">Fatturazione</h2>
        
        <!-- Billing Type Selection -->
        <div class="mb-4">
          <div class="space-y-2">
            <div>
              <label class="flex items-center">
                <input type="radio" name="tipo_fatturazione" value="privato" id="fatturazionePrivato" class="form-radio mr-2" onchange="toggleBillingType()" checked>
                <span class="font-medium text-sm">Fattura intestata a privato</span>
              </label>
            </div>
            <div>
              <label class="flex items-center">
                <input type="radio" name="tipo_fatturazione" value="azienda" id="fatturazioneAziendale" class="form-radio mr-2" onchange="toggleBillingType()">
                <span class="font-medium text-sm">Fattura intestata ad azienda</span>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Private Billing Fields -->
        <div id="privateBillingFields" class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-3">
          <div>
            <label class="block mb-0.5 font-medium text-sm">Nome *</label>
            <input type="text" name="fattura_nome" class="w-full border border-gray-300 py-1 px-2 rounded text-sm">
          </div>
          <div>
            <label class="block mb-0.5 font-medium text-sm">Cognome *</label>
            <input type="text" name="fattura_cognome" class="w-full border border-gray-300 py-1 px-2 rounded text-sm">
          </div>
          <div>
            <label class="block mb-0.5 font-medium text-sm">Codice Fiscale *</label>
            <input type="text" name="fattura_codice_fiscale" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" pattern="[A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z]" title="Formato: RSSMRA80A01H501X" oninput="this.value = this.value.toUpperCase()" maxlength="16">
          </div>
          
          <!-- Address Fields for Private Billing -->
          <div class="md:col-span-2 font-medium text-sm mb-0.5 mt-2">Indirizzo di Residenza *</div>
          <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-x-4">
            <div class="sm:col-span-2">
              <label class="block mb-0.5 font-medium text-sm">Via e Nr. Civico *</label>
              <input type="text" name="fattura_via_e_numero_civico" class="w-full border border-gray-300 py-1 px-2 rounded text-sm">
            </div>
            <div>
              <label class="block mb-0.5 font-medium text-sm">CAP *</label>
              <input type="text" name="fattura_cap" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" pattern="[0-9]{5}" title="Inserire 5 cifre" maxlength="5" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
            </div>
          </div>
          <div class="md:col-span-2">
            <label class="block mb-0.5 font-medium text-sm">Città di Residenza *</label>
            <input type="text" name="fattura_citta" class="w-full border border-gray-300 py-1 px-2 rounded text-sm">
          </div>
        </div>
        
        <!-- Company Billing Fields -->
        <div id="companyBillingFields" class="hidden grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-3">
          <div class="md:col-span-2">
            <label class="block mb-0.5 font-medium text-sm">Nome Completo dell'Azienda *</label>
            <input type="text" name="ragione_sociale" class="w-full border border-gray-300 py-1 px-2 rounded text-sm">
          </div>
          <div>
            <label class="block mb-0.5 font-medium text-sm">Partita IVA *</label>
            <input type="text" name="partita_iva" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" pattern="[0-9]{11}" title="Inserire 11 cifre" maxlength="11" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
          </div>
          <div>
            <label class="block mb-0.5 font-medium text-sm">Codice SDI *</label>
            <input type="text" name="codice_sdi" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" pattern="[A-Za-z0-9]{7}" title="Inserire codice alfanumerico di 7 caratteri" maxlength="7" oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');">
          </div>
          <div>
            <label class="block mb-0.5 font-medium text-sm">PEC Aziendale *</label>
            <input type="email" name="pec_azienda" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" title="Inserire indirizzo PEC valido">
          </div>
          
          <!-- Address Fields for Company Billing -->
          <div class="md:col-span-2 font-medium text-sm mb-0.5 mt-2">Indirizzo della Sede Legale *</div>
          <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-x-4">
            <div class="sm:col-span-2">
              <label class="block mb-0.5 font-medium text-sm">Via e Nr. Civico *</label>
              <input type="text" name="sede_via_e_numero_civico" class="w-full border border-gray-300 py-1 px-2 rounded text-sm">
            </div>
            <div>
              <label class="block mb-0.5 font-medium text-sm">CAP *</label>
              <input type="text" name="sede_cap" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" pattern="[0-9]{5}" title="Inserire 5 cifre" maxlength="5" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
            </div>
          </div>
          <div class="md:col-span-2">
            <label class="block mb-0.5 font-medium text-sm">Città *</label>
            <input type="text" name="sede_citta" class="w-full border border-gray-300 py-1 px-2 rounded text-sm">
          </div>
        </div>
      </section>

      <section class="bg-blue-50 p-4 rounded-lg">
        <h2 class="text-xl font-semibold mb-4">Riepilogo Costi</h2>
        <div class="space-y-3">
          <div class="bg-white p-3 rounded">
            <button type="button" id="togglePricingRulesButton" class="text-sm text-gray-600 mb-2 font-semibold hover:text-blue-600 focus:outline-none">
              Regole di Pricing <span id="pricingRulesArrow">&#9662;</span>
            </button>
            <ul id="pricingRulesList" class="text-xs text-gray-500 space-y-1 hidden"></ul>
          </div>
          <div>
            <p><strong>Dettaglio Costi per Persona:</strong></p>
            <div id="costoBase" class="text-sm bg-gray-50 p-2 rounded mt-1">€0</div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
            <p><strong>Numero Totale Persone:</strong> <span id="totalPersone">1</span></p>
                <p><strong>Camera:</strong> <span id="roomCountsDisplay">-</span></p>
          </div>
          <div>
            <p class="text-2xl font-bold text-blue-600">
                <strong>COSTO TOTALE: <span id="prezzoTotale">€0</span></strong>
            </p>
            </div>
          </div>
        </div>
      </section>

      <!-- MODALITA' DI PAGAMENTO Section -->
      <section class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">MODALITA' DI PAGAMENTO</h2>
        <div class="space-y-4 text-sm text-gray-700">
          <p>
            Per procedere alla prenotazione è necessario inviare entro il <strong>31 ottobre 2025</strong> il modulo compilato alla MAE' Viaggi. 
            Dopo la conferma di registrazione è necessario procedere con il pagamento della quota entro <strong>7 giorni lavorativi</strong>. 
            Il pagamento dell'intera quota è obbligatorio per la conferma della prenotazione della vacanza.
          </p>
          
          <p>
            Il pagamento della quota dovrà essere effettuato a mezzo <strong>bonifico bancario</strong> alle seguenti coordinate:
          </p>
          
          <div class="bg-white p-4 rounded border border-gray-300">
            <p class="font-semibold text-gray-800 mb-2">INTESA SAN PAOLO Spa - Fil. Porto d'Ascoli</p>
            <p class="mb-1"><strong>IBAN:</strong> IT79I0306924419100000002738</p>
            <p class="mb-1"><strong>Intestato a:</strong> LE MONDE S.r.l. - Via Liberazione, 150 - San Benedetto del Tronto (AP)</p>
            <p class="mb-1"><strong>PARTITA IVA/CODICE FISCALE:</strong> 01681040448</p>
            <p class="mb-1"><strong>COD. IDENTIFICATIVO:</strong> 0000000</p>
            <p class="mb-1"><strong>PEC:</strong> MAEGROUP@TDPEC.IT</p>
            <p class="mb-1"><strong>CAUSALE:</strong> Viaggio incentive Settimana Bianca 2026 Lafenice + Nome Partecipante + Ragione Sociale</p>
          </div>
          
          <p class="text-red-600 font-medium">
            Il mancato pagamento entro i termini indicati comporta l'annullamento della prenotazione.
          </p>
          
          <div class="bg-blue-50 p-3 rounded border border-blue-200">
            <p class="font-medium text-blue-800 mb-2">Per maggiori informazioni sul viaggio potete contattare MAE' VIAGGI</p>
            <p class="mb-1"><strong>Stefania Luciani</strong></p>
            <p class="mb-1"><strong>Cell.:</strong> 342 6481218</p>
            <p><strong>Email:</strong> stefania.luciani@maeviaggi.it</p>
          </div>
        </div>
      </section>

      <div class="pt-6">
        <label class="inline-flex items-center mb-2">
          <input type="checkbox" required class="form-checkbox mr-2">
          Confermo la veridicità e la correttezza dei dati inseriti e mi assumo la personale responsabilità di quanto scritto *
        </label>
      </div>

      <div class="pt-4">
        <button id="submitButton" type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded flex items-center justify-center">
          <span id="submitButtonText">Invia Iscrizione</span>
          <svg id="submitButtonSpinner" class="animate-spin ml-2 h-4 w-4 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </div>
    </form>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="mt-4 hidden">
      <div id="successMessage" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded hidden">
        Iscrizione completata con successo!
      </div>
      <div id="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded hidden">
        Errore durante l'iscrizione. Riprova.
      </div>
    </div>
  </div>

  <script>
    // --- Global State & Configuration ---
    let lastSubmissionId = sessionStorage.getItem('lastSubmissionId') || null;
    let lastEventName = '';
    let companionRoom1Count = 0;
    const MAX_COMPANIONS_ROOM1 = 3;

    let calculationDate = new Date(); // Default, will be updated by config
    let allGuestsWithCostsForPayload = [];
    let calculatedRoomCounts = { camera_singola: 0, camera_doppia: 0, camera_tripla: 0, camera_quadrupla: 0 };
    let phoneInput;
    let guestPhoneInputs = {}; // Store guest phone input instances
    let instanceName;
    let config = {}; // Store config data globally
    
    const prices = {
        adulto: {
            camera_doppia: 900,
            camera_singola: 1230
        },
        infant_0_2: 260, 
        bambino_2_13: { 
            terzo_quarto_letto: 490
        },
        adulto_13_plus_terzo_quarto_letto: 660
    };
    const provinceMap = [
      { name: "Agrigento", abbr: "AG" }, { name: "Alessandria", abbr: "AL" }, { name: "Ancona", abbr: "AN" }, { name: "Aosta", abbr: "AO" }, { name: "Arezzo", abbr: "AR" }, { name: "Ascoli Piceno", abbr: "AP" }, { name: "Asti", abbr: "AT" }, { name: "Avellino", abbr: "AV" }, { name: "Bari", abbr: "BA" }, { name: "Barletta-Andria-Trani", abbr: "BT" }, { name: "Belluno", abbr: "BL" }, { name: "Benevento", abbr: "BN" }, { name: "Bergamo", abbr: "BG" }, { name: "Biella", abbr: "BI" }, { name: "Bologna", abbr: "BO" }, { name: "Bolzano", abbr: "BZ" }, { name: "Brescia", abbr: "BS" }, { name: "Brindisi", abbr: "BR" }, { name: "Cagliari", abbr: "CA" }, { name: "Caltanissetta", abbr: "CL" }, { name: "Campobasso", abbr: "CB" }, { name: "Caserta", abbr: "CE" }, { name: "Catania", abbr: "CT" }, { name: "Catanzaro", abbr: "CZ" }, { name: "Chieti", abbr: "CH" }, { name: "Como", abbr: "CO" }, { name: "Cosenza", abbr: "CS" }, { name: "Cremona", abbr: "CR" }, { name: "Crotone", abbr: "KR" }, { name: "Cuneo", abbr: "CN" }, { name: "Enna", abbr: "EN" }, { name: "Fermo", abbr: "FM" }, { name: "Ferrara", abbr: "FE" }, { name: "Firenze", abbr: "FI" }, { name: "Foggia", abbr: "FG" }, { name: "Forlì-Cesena", abbr: "FC" }, { name: "Frosinone", abbr: "FR" }, { name: "Genova", abbr: "GE" }, { name: "Gorizia", abbr: "GO" }, { name: "Grosseto", abbr: "GR" }, { name: "Imperia", abbr: "IM" }, { name: "Isernia", abbr: "IS" }, { name: "L'Aquila", abbr: "AQ" }, { name: "La Spezia", abbr: "SP" }, { name: "Latina", abbr: "LT" }, { name: "Lecce", abbr: "LE" }, { name: "Lecco", abbr: "LC" }, { name: "Livorno", abbr: "LI" }, { name: "Lodi", abbr: "LO" }, { name: "Lucca", abbr: "LU" }, { name: "Macerata", abbr: "MC" }, { name: "Mantova", abbr: "MN" }, { name: "Massa-Carrara", abbr: "MS" }, { name: "Matera", abbr: "MT" }, { name: "Messina", abbr: "ME" }, { name: "Milano", abbr: "MI" }, { name: "Modena", abbr: "MO" }, { name: "Monza e Brianza", abbr: "MB" }, { name: "Napoli", abbr: "NA" }, { name: "Novara", abbr: "NO" }, { name: "Nuoro", abbr: "NU" }, { name: "Oristano", abbr: "OR" }, { name: "Padova", abbr: "PD" }, { name: "Palermo", abbr: "PA" }, { name: "Parma", abbr: "PR" }, { name: "Pavia", abbr: "PV" }, { name: "Perugia", abbr: "PG" }, { name: "Pesaro e Urbino", abbr: "PU" }, { name: "Pescara", abbr: "PE" }, { name: "Piacenza", abbr: "PC" }, { name: "Pisa", abbr: "PI" }, { name: "Pistoia", abbr: "PT" }, { name: "Pordenone", abbr: "PN" }, { name: "Potenza", abbr: "PZ" }, { name: "Prato", abbr: "PO" }, { name: "Ragusa", abbr: "RG" }, { name: "Ravenna", abbr: "RA" }, { name: "Reggio Calabria", abbr: "RC" }, { name: "Reggio Emilia", abbr: "RE" }, { name: "Rieti", abbr: "RI" }, { name: "Rimini", abbr: "RN" }, { name: "Roma", abbr: "RM" }, { name: "Rovigo", abbr: "RO" }, { name: "Salerno", abbr: "SA" }, { name: "Sassari", abbr: "SS" }, { name: "Savona", abbr: "SV" }, { name: "Siena", abbr: "SI" }, { name: "Siracusa", abbr: "SR" }, { name: "Sondrio", abbr: "SO" }, { name: "Sud Sardegna", abbr: "SU" }, { name: "Taranto", abbr: "TA" }, { name: "Teramo", abbr: "TE" }, { name: "Terni", abbr: "TR" }, { name: "Torino", abbr: "TO" }, { name: "Trapani", abbr: "TP" }, { name: "Trento", abbr: "TN" }, { name: "Treviso", abbr: "TV" }, { name: "Trieste", abbr: "TS" }, { name: "Udine", abbr: "UD" }, { name: "Varese", abbr: "VA" }, { name: "Venezia", abbr: "VE" }, { name: "Verbano-Cusio-Ossola", abbr: "VB" }, { name: "Vercelli", abbr: "VC" }, { name: "Verona", abbr: "VR" }, { name: "Vibo Valentia", abbr: "VV" }, { name: "Vicenza", abbr: "VI" }, { name: "Viterbo", abbr: "VT" }
    ].sort((a, b) => a.name.localeCompare(b.name));

    // --- Main Setup on DOMContentLoaded ---
    document.addEventListener('DOMContentLoaded', async () => {
      // For standalone service, use root-level API endpoints
      instanceName = 'root';

      const phoneInputField = document.querySelector("input[name='cellulare']");
      phoneInput = window.intlTelInput(phoneInputField, {
          initialCountry: "it",
          separateDialCode: true,
          utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js",
      });

      try {
          const response = await fetch(`/api/config`);
          if (response.ok) {
              config = await response.json();
              if (config.calculationDate) calculationDate = new Date(config.calculationDate);
              if (config.eventName) {
                  document.getElementById('event-title').textContent = config.eventName;
                  document.title = `${config.eventName} - Modulo Iscrizione`;
              }
              if (config.eventLocation) {
                  document.getElementById('event-location').textContent = config.eventLocation;
              }
              if (config.eventStartDate && config.eventEndDate) {
                  const startDate = new Date(config.eventStartDate);
                  const endDate = new Date(config.eventEndDate);
                  const formattedDates = `${startDate.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })} - ${endDate.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}`;
                  document.getElementById('event-dates').textContent = formattedDates;
              }
              if (config.deadlineSubmission) {
                  const deadlineDate = new Date(config.deadlineSubmission);
                  const formattedDeadline = deadlineDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' });
                  document.getElementById('deadline-date').textContent = formattedDeadline;
              }
          } else console.error('Failed to fetch config, using default date.');
      } catch (error) {
          console.error('Error fetching config:', error);
      }
      

      toggleBillingType();
      updatePricingRulesDisplay();
      calculateTotal();

      document.getElementById('registrationForm').addEventListener('submit', handleFormSubmission);
      document.getElementById('registrationForm').addEventListener('change', handleFormChange);
      document.getElementById('registrationForm').addEventListener('click', handleFormClick);
      document.getElementById('addCompanionRoom1Button').addEventListener('click', addCompanionRoom1);

      const togglePricingRulesButton = document.getElementById('togglePricingRulesButton');
      if (togglePricingRulesButton) togglePricingRulesButton.addEventListener('click', togglePricingRules);
      
      // Privacy modal event listeners
      const informativaLink = document.getElementById('informativa-link');
      const privacyModal = document.getElementById('privacy-modal');
      const closeModal = document.getElementById('close-modal');
      const closeModalBtn = document.getElementById('close-modal-btn');
      
      if (informativaLink) {
        informativaLink.addEventListener('click', function(e) {
          e.preventDefault();
          privacyModal.classList.remove('hidden');
        });
      }
      
      if (closeModal) {
        closeModal.addEventListener('click', function() {
          privacyModal.classList.add('hidden');
        });
      }
      
      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', function() {
          privacyModal.classList.add('hidden');
        });
      }
      
      // Close modal when clicking outside of it
      if (privacyModal) {
        privacyModal.addEventListener('click', function(e) {
          if (e.target === privacyModal) {
            privacyModal.classList.add('hidden');
          }
        });
      }
      
      // Close modal with Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !privacyModal.classList.contains('hidden')) {
          privacyModal.classList.add('hidden');
        }
      });
      
      // Modal event listeners removed since we're now using a success page
    });
    
    // PDF download function removed since it's now handled in the success page

    // --- Loading State Functions ---
    function showLoadingState() {
        const submitButton = document.getElementById('submitButton');
        const submitButtonText = document.getElementById('submitButtonText');
        const submitButtonSpinner = document.getElementById('submitButtonSpinner');
        
        submitButton.disabled = true;
        submitButton.classList.add('opacity-75', 'cursor-not-allowed');
        submitButton.classList.remove('hover:bg-blue-700');
        submitButtonText.textContent = 'Invio in corso...';
        submitButtonSpinner.classList.remove('hidden');
    }
    
    function hideLoadingState() {
        const submitButton = document.getElementById('submitButton');
        const submitButtonText = document.getElementById('submitButtonText');
        const submitButtonSpinner = document.getElementById('submitButtonSpinner');
        
        submitButton.disabled = false;
        submitButton.classList.remove('opacity-75', 'cursor-not-allowed');
        submitButton.classList.add('hover:bg-blue-700');
        submitButtonText.textContent = 'Invia Iscrizione';
        submitButtonSpinner.classList.add('hidden');
    }

    // --- Event Handlers ---
    async function handleFormSubmission(e) {
        e.preventDefault();
        calculateTotal();

        // Validate all fiscal codes before submission
        const validation = validateAllFiscalCodes();
        if (validation.hasErrors) {
            const mc = document.getElementById('messageContainer');
            const em = document.getElementById('errorMessage');
            mc.classList.remove('hidden');
            em.innerHTML = `<strong>Errori di validazione:</strong><br>• ${validation.errorMessages.join('<br>• ')}`;
            em.classList.remove('hidden');
            document.getElementById('successMessage').classList.add('hidden');
            
            // Scroll to the error message
            mc.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        const ospiti = allGuestsWithCostsForPayload.map(guestInfo => {
            const prefix = `${guestInfo.type}_${guestInfo.form_index}`;
            const isFirstGuest = guestInfo.form_index === 1;
            
            // Basic data for all guests
            const guestData = {
                nome: formData.get(`${prefix}_nome`), 
                cognome: formData.get(`${prefix}_cognome`),
                data_nascita: formData.get(`${prefix}_data_nascita`), 
                luogo_nascita: formData.get(`${prefix}_luogo_nascita`), 
                cittadinanza: formData.get(`${prefix}_cittadinanza`),
                esigenze_alimentari: formData.get(`${prefix}_esigenze_alimentari`) || '',
                consenso_dati_alimentari: formData.get(`${prefix}_consenso_dati_alimentari`) || null
            };
            
                         // Additional data only for guest #1
             if (isFirstGuest) {
                 const guestPhoneInput = guestPhoneInputs[guestInfo.form_index];
                 const cellulareNumber = guestPhoneInput ? guestPhoneInput.getNumber() : formData.get(`${prefix}_cellulare`);
                 
                 guestData.email = formData.get(`${prefix}_email`);
                 guestData.cellulare = cellulareNumber;
             }
            
            return guestData;
        });

        const payload = {
            nome: data.nome, cognome: data.cognome, email: data.email, cellulare: phoneInput.getNumber(),
            data_nascita: data.data_nascita,
            luogo_nascita: data.luogo_nascita, cittadinanza: data.cittadinanza,
            esigenze_alimentari: data.esigenze_alimentari || '',
            consenso_dati_alimentari: data.consenso_dati_alimentari || null,
            evento: config.eventName || 'Evento',
            agente: data.agente_riferimento,
            ...calculatedRoomCounts,
            costo_totale_gruppo: parseFloat(document.getElementById('prezzoTotale').textContent.replace('€', '')),
            ospiti: ospiti,
            tipo_fatturazione: data.tipo_fatturazione,
            dati_fatturazione: data.tipo_fatturazione === 'azienda' ? {
                ragione_sociale: data.ragione_sociale, 
                partita_iva: data.partita_iva,
                codice_sdi: data.codice_sdi,
                pec_azienda: data.pec_azienda,
                sede_via_e_numero_civico: data.sede_via_e_numero_civico,
                sede_cap: data.sede_cap,
                sede_citta: data.sede_citta
            } : {
                nome: data.fattura_nome,
                cognome: data.fattura_cognome,
                codice_fiscale: data.fattura_codice_fiscale,
                fattura_via_e_numero_civico: data.fattura_via_e_numero_civico,
                fattura_cap: data.fattura_cap,
                fattura_citta: data.fattura_citta,
                indirizzo_residenza: data.fattura_via_e_numero_civico ? `${data.fattura_via_e_numero_civico}, ${data.fattura_cap} ${data.fattura_citta}` : ''
            }
        };
        
        // Show loading state before making the request
        showLoadingState();
        
        const mc = document.getElementById('messageContainer'), sm = document.getElementById('successMessage'), em = document.getElementById('errorMessage');
        try {
            const response = await fetch(`/api/registrati`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();
            
            if (response.ok && result.success) {
                // Hide loading state on success
                hideLoadingState();
                
                // Store submission data for the success page
                lastSubmissionId = result.id;
                lastEventName = payload.evento;
                
                // Redirect to success page with registration details
                const successUrl = `/success?id=${result.id}&email=${encodeURIComponent(payload.email)}&event=${encodeURIComponent(payload.evento)}`;
                window.location.href = successUrl;
            } else { 
                // Hide loading state on error
                hideLoadingState();
                
                mc.classList.remove('hidden');
                em.textContent = result.error || 'Errore durante l\'iscrizione.';
                em.classList.remove('hidden');
                sm.classList.add('hidden');
            }
        } catch (error) {
            // Hide loading state on error
            hideLoadingState();
            
            console.error('Error submitting form:', error);
            em.textContent = 'Errore di connessione. Riprova.';
            em.classList.remove('hidden');
            sm.classList.add('hidden');
            mc.classList.remove('hidden');
        }
    }

    function handleFormChange(e) {
      if (e.target.matches('input[name*="data_nascita"]')) calculateTotal();
      if (e.target.matches('input[name="tipo_fatturazione"]')) toggleBillingType();

    }
    
    function handleFormClick(e) {
        if (e.target.matches('.remove-guest-button')) {
            const guestBlock = e.target.closest('.guest-block');
            const roomType = guestBlock.dataset.removeRoom;
            guestBlock.remove();
            if (roomType === 'room1') {
                // Clean up phone input instances for removed guests
                cleanupGuestPhoneInputs();
                
                companionRoom1Count = document.getElementById('companionFieldsRoom1').children.length;
                renumberGuests('room1');
                
                // Reinitialize phone inputs for remaining guests
                reinitializeAllGuestPhoneInputs();
                
                document.getElementById('addCompanionRoom1Button').classList.toggle('hidden', companionRoom1Count >= MAX_COMPANIONS_ROOM1);
                document.getElementById('room1MaxReachedText').classList.toggle('hidden', companionRoom1Count < MAX_COMPANIONS_ROOM1);
            }
            calculateTotal();
        }
    }

    function renumberGuests(roomType) {
        const containerId = 'companionFieldsRoom1';
        const container = document.getElementById(containerId);
        const guestBlocks = container.children;
        
        for (let i = 0; i < guestBlocks.length; i++) {
            const guestBlock = guestBlocks[i];
            const newIndex = i + 1;
            
            // Update the title
            const titleElement = guestBlock.querySelector('h3');
            titleElement.textContent = `Ospite ${newIndex}`;
            
            // Update all form field names and IDs
            const prefix = 'ospite_room1';
            const newPrefix = `${prefix}_${newIndex}`;
            
            // Get all input and select elements
            const formElements = guestBlock.querySelectorAll('input, select');
            formElements.forEach(element => {
                if (element.name) {
                    // Update name attribute
                    const namePattern = new RegExp(`${prefix}_\\d+`);
                    element.name = element.name.replace(namePattern, newPrefix);
                }
                if (element.id) {
                    // Update id attribute
                    const idPattern = new RegExp(`${prefix}_\\d+`);
                    element.id = element.id.replace(idPattern, newPrefix);
                }
                // Update oninput and onchange attributes
                if (element.getAttribute('oninput')) {
                    const oninputPattern = new RegExp(`'${prefix}_\\d+'`, 'g');
                    element.setAttribute('oninput', element.getAttribute('oninput').replace(oninputPattern, `'${newPrefix}'`));
                }
                if (element.getAttribute('onchange')) {
                    const onchangePattern = new RegExp(`'${prefix}_\\d+'`, 'g');
                    element.setAttribute('onchange', element.getAttribute('onchange').replace(onchangePattern, `'${newPrefix}'`));
                }
            });
            
            // Update label for attributes
            const labels = guestBlock.querySelectorAll('label[for]');
            labels.forEach(label => {
                if (label.getAttribute('for')) {
                    const forPattern = new RegExp(`${prefix}_\\d+`);
                    label.setAttribute('for', label.getAttribute('for').replace(forPattern, newPrefix));
                }
            });
            
            // Update data-prefix attributes
            const elementsWithDataPrefix = guestBlock.querySelectorAll('[data-prefix]');
            elementsWithDataPrefix.forEach(element => {
                const dataPrefixPattern = new RegExp(`${prefix}_\\d+`);
                element.setAttribute('data-prefix', element.getAttribute('data-prefix').replace(dataPrefixPattern, newPrefix));
            });
            
            // Update validation div IDs
            const validationDivs = guestBlock.querySelectorAll('div[id*="_validation"]');
            validationDivs.forEach(div => {
                const validationIdPattern = new RegExp(`${prefix}_\\d+`);
                div.id = div.id.replace(validationIdPattern, newPrefix);
            });
            

        }
    }

    // --- UI Update Functions ---
    function resetFullUI() {
        cleanupGuestPhoneInputs();
        document.getElementById('companionFieldsRoom1').innerHTML = '';
        companionRoom1Count = 0;
        document.getElementById('addCompanionRoom1Button').classList.remove('hidden');
        document.getElementById('room1MaxReachedText').classList.add('hidden');
        calculateTotal();
    }



    function addCompanionRoom1() {
      if (companionRoom1Count < MAX_COMPANIONS_ROOM1) {
        companionRoom1Count++;
            const newBlock = createGuestBlockHTML('room1', companionRoom1Count);
            document.getElementById('companionFieldsRoom1').insertAdjacentHTML('beforeend', newBlock);
            
            // Initialize phone input for the new guest
            initializeGuestPhoneInput(companionRoom1Count);

        calculateTotal();
            document.getElementById('addCompanionRoom1Button').classList.toggle('hidden', companionRoom1Count >= MAX_COMPANIONS_ROOM1);
            document.getElementById('room1MaxReachedText').classList.toggle('hidden', companionRoom1Count < MAX_COMPANIONS_ROOM1);
      }
    }
    
    function initializeGuestPhoneInput(guestIndex) {
        // Only initialize phone input for guest #1 (who has phone field)
        if (guestIndex === 1) {
            const phoneInputField = document.querySelector(`#ospite_room1_${guestIndex}_cellulare`);
            if (phoneInputField) {
                guestPhoneInputs[guestIndex] = window.intlTelInput(phoneInputField, {
                    initialCountry: "it",
                    separateDialCode: true,
                    utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js",
                });
            }
        }
    }
    
    function cleanupGuestPhoneInputs() {
        // Destroy all existing phone input instances
        Object.values(guestPhoneInputs).forEach(phoneInput => {
            if (phoneInput && phoneInput.destroy) {
                phoneInput.destroy();
            }
        });
        guestPhoneInputs = {};
    }
    
    function reinitializeAllGuestPhoneInputs() {
        // Only reinitialize phone input for guest #1 (if exists)
        if (companionRoom1Count >= 1) {
            initializeGuestPhoneInput(1);
        }
    }




    
    function toggleBillingType() {
        const isCompanyBilling = document.getElementById('fatturazioneAziendale').checked;
        const privateFields = document.getElementById('privateBillingFields');
        const companyFields = document.getElementById('companyBillingFields');
        
        // Toggle visibility
        privateFields.classList.toggle('hidden', isCompanyBilling);
        companyFields.classList.toggle('hidden', !isCompanyBilling);
        
        // Handle private billing fields
        privateFields.querySelectorAll('input').forEach(input => {
            input.disabled = isCompanyBilling;
            input.required = !isCompanyBilling;
            if (isCompanyBilling) {
                input.value = '';
            }
        });
        
        // Handle company billing fields
        companyFields.querySelectorAll('input').forEach(input => {
            input.disabled = !isCompanyBilling;
            input.required = isCompanyBilling;
            if (!isCompanyBilling) {
                input.value = '';
            }
        });
    }

    function togglePricingRules() {
        const pricingRulesList = document.getElementById('pricingRulesList');
        const pricingRulesArrow = document.getElementById('pricingRulesArrow');
        const isHidden = pricingRulesList.classList.toggle('hidden');
        this.childNodes[0].nodeValue = isHidden ? "Regole di Pricing " : "Regole di Pricing ";
        pricingRulesArrow.innerHTML = isHidden ? '&#9662;' : '&#9652;';
    }

    // --- Calculation & HTML Generation ---
    function createGuestBlockHTML(roomType, index) {
        const prefix = `ospite_room1_${index}`;
        const title = `Ospite ${index}`;
        const isFirstGuest = index === 1;
        
        // Common fields for all guests
        const commonFields = `
                                 <div>
                     <label class="block mb-0.5 font-medium text-sm">Nome *</label>
                     <input type="text" name="${prefix}_nome" id="${prefix}_nome" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" required>
                 </div>
                 <div>
                     <label class="block mb-0.5 font-medium text-sm">Cognome *</label>
                     <input type="text" name="${prefix}_cognome" id="${prefix}_cognome" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" required>
                 </div>
                 <div>
                     <label class="block mb-0.5 font-medium text-sm">Data di Nascita *</label>
                     <input type="date" name="${prefix}_data_nascita" id="${prefix}_data_nascita" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" required onchange="calculateTotal()">
                 </div>
                
                <div>
                    <label class="block mb-0.5 font-medium text-sm">Luogo di Nascita *</label>
                    <input type="text" name="${prefix}_luogo_nascita" id="${prefix}_luogo_nascita" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" required>
                </div>
                <div>
                    <label class="block mb-0.5 font-medium text-sm">Cittadinanza *</label>
                    <input type="text" name="${prefix}_cittadinanza" id="${prefix}_cittadinanza" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" required value="Italiana">
                </div>`;
        
        // Additional fields only for guest #1
        const additionalFields = isFirstGuest ? `
                <div>
                    <label class="block mb-0.5 font-medium text-sm">Email *</label>
                    <input type="email" name="${prefix}_email" id="${prefix}_email" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" required>
                </div>
                <div class="w-full">
                    <label class="block mb-0.5 font-medium text-sm">Cellulare *</label>
                    <input type="tel" name="${prefix}_cellulare" id="${prefix}_cellulare" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" required pattern="[0-9]{9,10}" maxlength="10" title="Inserire un numero di 9-10 cifre" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
                <!-- Contact Information Notice -->
                <div class="md:col-span-2">
                    <p class="text-sm text-gray-600 italic">I recapiti forniti saranno utilizzati per tutte le comunicazioni inerenti al viaggio</p>
                </div>` : '';
        
        // Dietary requirements for all guests
        const dietaryField = `
                <div class="md:col-span-2">
                    <label class="block mb-0.5 font-medium text-sm">Esigenze Alimentari</label>
                    <textarea name="${prefix}_esigenze_alimentari" id="${prefix}_esigenze_alimentari" class="w-full border border-gray-300 py-1 px-2 rounded text-sm" rows="3" placeholder="Specificare eventuali allergie o intolleranze alimentari"></textarea>
                    <div class="mt-2">
                        <p class="text-sm text-gray-600 italic mb-1">Queste informazioni saranno utilizzate solo per garantire un servizio adeguato. *</p>
                        <div class="flex items-center gap-4 text-sm">
                            <label class="inline-flex items-center gap-2">
                                <input type="radio" name="${prefix}_consenso_dati_alimentari" id="${prefix}_consenso_dati_alimentari_si" value="si" class="h-4 w-4" checked>
                                <span>Acconsento al trattamento dei miei dati alimentari</span>
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="radio" name="${prefix}_consenso_dati_alimentari" id="${prefix}_consenso_dati_alimentari_no" value="no" class="h-4 w-4">
                                <span>Non acconsento</span>
                            </label>
                        </div>
                        <div class="mt-2">
                            <br />
                            <label class="inline-flex items-center text-sm">
                                <input type="checkbox" required class="form-checkbox mr-2">
                                Dichiaro di aver letto e compreso l'<span class="text-blue-600 hover:text-blue-800 underline cursor-pointer" onclick="document.getElementById('privacy-modal').classList.remove('hidden')">informativa</span> *
                            </label>
                        </div>
                    </div>
                </div>`;
        
        return `
        <div class="guest-block bg-gray-50 p-3 rounded-lg mb-3 border border-gray-200" data-remove-room="room1">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-semibold text-base">${title}</h3>
                <button type="button" class="remove-guest-button text-red-500 hover:text-red-700 font-semibold text-xs">Rimuovi</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
                ${commonFields}
                ${additionalFields}
                ${dietaryField}
            </div>
        </div>`;
    }

    function calculateAge(birthDate) {
        if (!birthDate || isNaN(new Date(birthDate))) return null; // Return null for invalid/empty dates
      const birth = new Date(birthDate);
      let age = calculationDate.getFullYear() - birth.getFullYear();
        const m = calculationDate.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && calculationDate.getDate() < birth.getDate())) age--;
      return age;
    }

    function populateProvinceDropdown(selectElement) {
      if (!selectElement) return;
        selectElement.innerHTML = '';
      selectElement.add(new Option("--- Seleziona ---", ""));
        provinceMap.forEach(p => selectElement.add(new Option(p.name, p.abbr)));
    }
    
    function calculateTotal() {
        allGuestsWithCostsForPayload = [];
      calculatedRoomCounts = { camera_singola: 0, camera_doppia: 0, camera_tripla: 0, camera_quadrupla: 0, camera_quintupla: 0 };
        const costBreakdownEl = document.getElementById('costoBase');
        
        let totalCost = 0, totalPeople = 0, costBreakdownHTML = '';
        
        // --- Process Room 1 ---
        const room1Occupants = [{ age: calculateAge(document.querySelector('[name="data_nascita"]').value), name: "Partecipante", type: 'capogruppo', form_index: 0 }];
        document.querySelectorAll('#companionFieldsRoom1 .guest-block').forEach((block, i) => {
            room1Occupants.push({ age: calculateAge(block.querySelector('[name*="data_nascita"]').value), name: `Ospite ${i+1}`, type: 'ospite_room1', form_index: i+1 });
        });
        
        if(room1Occupants.length > 0) {
            totalPeople += room1Occupants.length;
            room1Occupants.forEach((occupant, i) => {
                let cost = getOccupantCost(occupant.age, i + 1, room1Occupants.length);
                let label = getOccupantLabel(occupant.age, i + 1, room1Occupants.length);
                totalCost += cost;
                const ageDisplay = occupant.age !== null ? `Età: ${occupant.age}` : 'Età: non specificata';
                costBreakdownHTML += `<div>${occupant.name} (${ageDisplay}) - ${label}: €${cost.toFixed(2)}</div>`;
                if(occupant.type !== 'capogruppo') allGuestsWithCostsForPayload.push(occupant);
            });
            
            // Determine room type based on occupancy
            const roomTypes = ['', 'camera_singola', 'camera_doppia', 'camera_tripla', 'camera_quadrupla', 'camera_quintupla'];
            const roomType = roomTypes[Math.min(room1Occupants.length, 5)] || 'camera_quintupla';
            calculatedRoomCounts[roomType]++;
        }
        

        
        costBreakdownEl.innerHTML = costBreakdownHTML || 'Aggiungi partecipanti.';
        document.getElementById('totalPersone').textContent = totalPeople;
        document.getElementById('prezzoTotale').textContent = `€${totalCost.toFixed(2)}`;
        document.getElementById('roomCountsDisplay').textContent = Object.entries(calculatedRoomCounts).filter(([,val]) => val > 0).map(([key, val]) => `${val} ${key.replace(/_/g, ' ')}`).join(', ') || 'Nessuna';
    }

    function getOccupantCost(age, positionInRoom, totalInRoom) {
        // If age is null (no birth date provided), return 0 - no cost calculated
        if (age === null) return 0;
        
        // Infants 0-2 years (not completed) always pay infant price
        if (age < 2) return prices.infant_0_2;
        
        // First and second occupants in room
        if (positionInRoom <= 2) {
            if (totalInRoom === 1) {
                // Single room - adult price for single use of double room
                return prices.adulto.camera_singola;
            } else {
                // Double room - both first and second occupant pay adult double room price
                // Note: even if second participant is a minor, they pay adult price per specifications
                return prices.adulto.camera_doppia;
            }
        }
        
        // Third and fourth bed occupants
        if (positionInRoom >= 3) {
            if (age < 13) {
                // Children 2-13 years (not completed) in 3rd/4th bed
                return prices.bambino_2_13.terzo_quarto_letto;
            } else {
                // Adults (13+ years) in 3rd/4th bed
                return prices.adulto_13_plus_terzo_quarto_letto;
            }
        }
        
        return 0; // Fallback
    }
    
    function getOccupantLabel(age, positionInRoom, totalInRoom) {
        // If age is null (no birth date provided), show appropriate message
        if (age === null) {
            return "";
        }
        
        if (age < 2) return "Infant 0-2 anni non compiuti";
        
        if (positionInRoom <= 2) {
            if (totalInRoom === 1) {
                return "Adulto in camera doppia uso singola";
            } else {
                return "Adulto in camera doppia";
            }
        }
        
        if (positionInRoom >= 3) {
            const bedType = positionInRoom === 3 ? "3° letto" : "4° letto";
            if (age < 13) {
                return `Bambino 2-13 anni non compiuti in ${bedType}`;
            } else {
                return `Adulto (≥ 13 anni) in ${bedType}`;
            }
        }
        
        return "Occupante"; // Fallback
    }
    
    function updatePricingRulesDisplay() {
      const rulesList = document.querySelector('#pricingRulesList');
      const formattedDate = calculationDate.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
        rulesList.innerHTML = `
            <li class="font-semibold mt-1">Quota adulto in camera doppia: €${prices.adulto.camera_doppia.toFixed(2)}</li>
            <li class="font-semibold mt-1">Quota adulto in camera doppia uso singola: €${prices.adulto.camera_singola.toFixed(2)}</li>
            <li class="font-semibold mt-1">Quota infant 0-2 anni non compiuti: €${prices.infant_0_2.toFixed(2)}</li>
            <li class="font-semibold mt-1">Quota bambino 2-13 anni non compiuti in 3°-4° letto: €${prices.bambino_2_13.terzo_quarto_letto.toFixed(2)}</li>
            <li class="font-semibold mt-1">Quota adulto (dai 13 anni) in 3°-4° letto: €${prices.adulto_13_plus_terzo_quarto_letto.toFixed(2)}</li>
            <p class="text-xs mt-3 font-semibold text-blue-600">NOTA BENE:</p>
            <li class="text-xs">• L'età viene calcolata alla data di partenza (${formattedDate})</li>
            <li class="text-xs">• Ogni camera doppia prevede il pagamento di due quote adulto, anche se il secondo partecipante è minorenne</li>
            <li class="text-xs">• La disponibilità di camere quintuple è soggetta a richiesta e riconferma</li>
        `;
    }

    // Fiscal Code Validation Functions
    function extractConsonants(str) {
        // Remove accents and normalize, then extract consonants
        const normalized = str.toUpperCase()
            .replace(/[ÀÁÂÃÄÅ]/g, 'A')
            .replace(/[ÈÉÊË]/g, 'E')
            .replace(/[ÌÍÎÏ]/g, 'I')
            .replace(/[ÒÓÔÕÖ]/g, 'O')
            .replace(/[ÙÚÛÜ]/g, 'U')
            .replace(/[^A-Z]/g, '');
        return normalized.replace(/[AEIOU]/g, '');
    }

    function extractVowels(str) {
        // Remove accents and normalize, then extract vowels
        const normalized = str.toUpperCase()
            .replace(/[ÀÁÂÃÄÅ]/g, 'A')
            .replace(/[ÈÉÊË]/g, 'E')
            .replace(/[ÌÍÎÏ]/g, 'I')
            .replace(/[ÒÓÔÕÖ]/g, 'O')
            .replace(/[ÙÚÛÜ]/g, 'U')
            .replace(/[^A-Z]/g, '');
        return normalized.replace(/[^AEIOU]/g, '');
    }

    function generateNameCode(name) {
        const consonants = extractConsonants(name);
        const vowels = extractVowels(name);
        
        // Special rule for names: if 4+ consonants, take 1st, 3rd, 4th
        if (consonants.length >= 4) {
            return consonants.charAt(0) + consonants.charAt(2) + consonants.charAt(3);
        } else if (consonants.length >= 3) {
            return consonants.substring(0, 3);
        } else {
            return (consonants + vowels + 'XXX').substring(0, 3);
        }
    }

    function generateSurnameCode(surname) {
        const consonants = extractConsonants(surname);
        const vowels = extractVowels(surname);
        
        // For surnames: take first 3 consonants, then vowels if needed
        if (consonants.length >= 3) {
            return consonants.substring(0, 3);
        } else {
            return (consonants + vowels + 'XXX').substring(0, 3);
        }
    }

    // Check digit validation tables and function
    function calculateCheckDigit(fiscalCode15) {
        // Odd position values (1st, 3rd, 5th, etc. - 0-indexed: 0, 2, 4, etc.)
        const oddValues = {
            '0': 1, '1': 0, '2': 5, '3': 7, '4': 9, '5': 13, '6': 15, '7': 17, '8': 19, '9': 21,
            'A': 1, 'B': 0, 'C': 5, 'D': 7, 'E': 9, 'F': 13, 'G': 15, 'H': 17, 'I': 19, 'J': 21,
            'K': 2, 'L': 4, 'M': 18, 'N': 20, 'O': 11, 'P': 3, 'Q': 6, 'R': 8, 'S': 12, 'T': 14,
            'U': 16, 'V': 10, 'W': 22, 'X': 25, 'Y': 24, 'Z': 23
        };

        // Even position values (2nd, 4th, 6th, etc. - 0-indexed: 1, 3, 5, etc.)
        const evenValues = {
            '0': 0, '1': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9,
            'A': 0, 'B': 1, 'C': 2, 'D': 3, 'E': 4, 'F': 5, 'G': 6, 'H': 7, 'I': 8, 'J': 9,
            'K': 10, 'L': 11, 'M': 12, 'N': 13, 'O': 14, 'P': 15, 'Q': 16, 'R': 17, 'S': 18, 'T': 19,
            'U': 20, 'V': 21, 'W': 22, 'X': 23, 'Y': 24, 'Z': 25
        };

        // Check digit table
        const checkDigits = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];

        let sum = 0;
        for (let i = 0; i < 15; i++) {
            const char = fiscalCode15.charAt(i);
            if (i % 2 === 0) {
                // Odd position (1-indexed)
                sum += oddValues[char] || 0;
            } else {
                // Even position (1-indexed)
                sum += evenValues[char] || 0;
            }
        }

        return checkDigits[sum % 26];
    }

    function validateCheckDigit(fiscalCode) {
        if (fiscalCode.length !== 16) return false;
        const first15 = fiscalCode.substring(0, 15);
        const checkDigit = fiscalCode.charAt(15);
        const expectedCheckDigit = calculateCheckDigit(first15);
        return checkDigit === expectedCheckDigit;
    }

    function decodeBirthDateFromFiscalCode(fiscalCode) {
        if (fiscalCode.length < 11) return null;
        
        // Extract year, month, day from fiscal code
        const yearStr = fiscalCode.substring(6, 8);
        const monthChar = fiscalCode.substring(8, 9);
        const dayStr = fiscalCode.substring(9, 11);
        
        // Month mapping
        const monthMap = {
            'A': '01', 'B': '02', 'C': '03', 'D': '04', 'E': '05', 'H': '06',
            'L': '07', 'M': '08', 'P': '09', 'R': '10', 'S': '11', 'T': '12'
        };
        
        const month = monthMap[monthChar];
        if (!month) return null;
        
        // Day calculation (subtract 40 if >= 40, indicating female)
        let day = parseInt(dayStr);
        const isFemale = day > 40;
        if (isFemale) day -= 40;
        
        // Year calculation (assume 1900s for years > 50, 2000s for years <= 50)
        let year = parseInt(yearStr);
        year += (year > 50) ? 1900 : 2000;
        
        return {
            year: year,
            month: month,
            day: day.toString().padStart(2, '0'),
            isFemale: isFemale,
            dateString: `${year}-${month}-${day.toString().padStart(2, '0')}`
        };
    }



                 

     

     function validateAllFiscalCodes() {
         let hasErrors = false;
         const errorMessages = [];

         // Helper function to validate a single fiscal code
         function validateSingleFiscalCode(nome, cognome, codiceFiscale, birthDate, personLabel) {
             // Check format
             if (!/^[A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z]$/.test(codiceFiscale)) {
                 hasErrors = true;
                 errorMessages.push(`${personLabel}: Formato codice fiscale non valido`);
                 return;
             }

             // Check control digit
             if (!validateCheckDigit(codiceFiscale)) {
                 hasErrors = true;
                 errorMessages.push(`${personLabel}: Carattere di controllo del codice fiscale non corretto`);
                 return;
             }

             // Check birth date correspondence
             const decodedData = decodeBirthDateFromFiscalCode(codiceFiscale);
             if (!decodedData) {
                 hasErrors = true;
                 errorMessages.push(`${personLabel}: Impossibile decodificare la data dal codice fiscale`);
                 return;
             }

             if (decodedData.dateString !== birthDate) {
                 hasErrors = true;
                 errorMessages.push(`${personLabel}: Data di nascita non corrisponde al codice fiscale (prevista: ${decodedData.dateString})`);
             }

             // Check name and surname correspondence
             const expectedSurnameCode = generateSurnameCode(cognome);
             const expectedNameCode = generateNameCode(nome);
             const fiscalSurnameCode = codiceFiscale.substring(0, 3);
             const fiscalNameCode = codiceFiscale.substring(3, 6);

             if (fiscalSurnameCode !== expectedSurnameCode) {
                 hasErrors = true;
                 errorMessages.push(`${personLabel}: Cognome non corrisponde al codice fiscale (inserito: ${expectedSurnameCode}, trovato: ${fiscalSurnameCode})`);
             }

             if (fiscalNameCode !== expectedNameCode) {
                 hasErrors = true;
                 errorMessages.push(`${personLabel}: Nome non corrisponde al codice fiscale (inserito: ${expectedNameCode}, trovato: ${fiscalNameCode})`);
             }
         }

         // Main participant no longer has fiscal code field, so skip validation

                   // Guest forms no longer have fiscal code fields, so skip validation

         return { hasErrors, errorMessages };
     }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js"></script>

  
  
  <!-- Success modal removed - now using dedicated success page -->

  <!-- Privacy Policy Modal -->
  <div id="privacy-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 flex-shrink-0">
          <h3 class="text-xl font-semibold text-gray-900">Informativa Privacy</h3>
          <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto flex-1 min-h-0">
          <div class="prose max-w-none text-sm leading-relaxed">
            <h2 class="text-lg font-bold mb-4">INFORMATIVA RELATIVA AL TRATTAMENTO DEI DATI PERSONALI</h2>
            <p class="mb-2">Ai sensi e dell'art. 13 del GDPR Regolamento UE n. 2016/679</p>
            <p class="mb-4 font-semibold">Doc. Aggiornato al 29/01/2025</p>
            
            <p class="mb-4">
              La LE MONDE Srl, in qualità di titolare del trattamento ai sensi degli articoli 4, n. 7)
              e 24 del Regolamento UE 2016/679 del 27/04/2016 relativo alla protezione dei dati
              personali delle persone fisiche con riguardo al trattamento dei dati personali (di seguito,
              "GDPR") La informa, ai sensi degli Artt. 13 e 14 del "GDPR" con riferimento ai Suoi
              Dati Personali richiesti dalla stessa nell'ambito dei servizi di intermediazione di
              pacchetti turistici intercorrenti, che tale trattamento sarà improntato ai principi di
              correttezza, liceità e trasparenza e di tutela della Sua riservatezza e dei Suoi diritti. A
              tal proposito La preghiamo di leggere attentamente la presente Informativa.
            </p>

            <h3 class="text-base font-bold mb-2">1) Oggetto del Trattamento</h3>
            <p class="mb-4">
              Il Titolare del Trattamento tratta i dati personali identificativi in particolare: nome,
              cognome, codice fiscale, p.iva, e-mail, numero telefonico, indirizzo di residenza, ecc,
              da Lei comunicati con il presente modulo e quelli ulteriori che avremo assoluta
              necessità di rilevare in fase precontrattuale e/o contrattuale ovvero all'atto della
              conclusione di un contratto di servizi. Inoltre, potrebbero essere trattati categorie
              particolari di dati "c.d. sensibili" relativi allo stato di salute per particolari esigenze
              alimentari o legate al viaggio/soggiorno.
            </p>

            <h3 class="text-base font-bold mb-2">2) Finalità del Trattamento e Base Giuridica</h3>
            <p class="mb-2">I Dati vengono da noi raccolti presso l'interessato con le seguenti finalità:</p>
            
            <div class="mb-4">
              <table class="w-full border-collapse border border-gray-300">
                <tbody>
                  <tr>
                    <td class="border border-gray-300 p-3">
                      <strong>2.1</strong> la vendita, l'organizzazione e l'intermediazione
                      nell'acquisto di un pacchetto turistico, biglietteria e
                      titoli di viaggio organizzato da terzi o di singoli
                      servizi turistici prestati da terzi fornitori (es. Aziende,
                      albergatori, vettori, ecc.);
                    </td>
                    <td class="border border-gray-300 p-3 text-sm text-gray-600 align-top" rowspan="4">
                      La base giuridica si fonda
                      su obblighi contrattuali e/o
                      precontrattuali sottoscritti
                      di cui l'interessato è parte.
                    </td>
                  </tr>
                  <tr class="bg-gray-50">
                    <td class="border border-gray-300 p-3">
                      <strong>2.2</strong> l'intermediazione nell'acquisto di servizi
                      finanziari/assicurativi accessori e collegati ai
                      pacchetti/servizi turistici agevolati o acquistati
                      singolarmente (polizze sanitarie; bagaglio;
                      annullamento; assistenza al viaggiatore in difficoltà;
                      finanziamenti credito al consumo ecc.);
                    </td>
                  </tr>
                  <tr>
                    <td class="border border-gray-300 p-3">
                      <strong>2.3</strong> per adempiere all'incarico relativo al rilascio di
                      visti e permessi di soggiorno turistici;
                    </td>
                  </tr>
                  <tr class="bg-gray-50">
                    <td class="border border-gray-300 p-3">
                      <strong>2.4</strong> per finalità connesse a Obblighi legali:
                      fatturazione, scritture e registrazioni contabili
                      obbligatorie, e tutela di credito e tutela dei diritti in
                      sede giudiziaria.
                    </td>
                  </tr>
                  <tr>
                    <td class="border border-gray-300 p-3">
                      <strong>2.5</strong> Solo con esplicito consenso, per Finalità
                      Promozionali e di Marketing, e informazioni
                      commerciali circa le opportunità e offerte Turistiche.
                    </td>
                    <td class="border border-gray-300 p-3 text-sm text-gray-600">
                      La base giuridica è il
                      consenso espresso
                      dell'interessato.
                    </td>
                  </tr>
                  <tr class="bg-gray-50">
                    <td class="border border-gray-300 p-3">
                      <strong>2.6</strong> Solo con Esplicito consenso, trattamento di dati
                      sulla salute per particolari esigenze alimentari o
                      disabilità specifiche legate al viaggio/soggiorno e
                      loro comunicazione a strutture ricettive o vettori.
                    </td>
                    <td class="border border-gray-300 p-3 text-sm text-gray-600">
                      La base giuridica è il
                      consenso espresso
                      dell'interessato.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <h3 class="text-base font-bold mb-2">3) Modalità di Trattamento</h3>
            <p class="mb-4">
              I Dati vengono da noi trattati sia manualmente, e la documentazione cartacea relativa
              verrà da noi correttamente mantenuta e protetta per tutto il tempo necessario al
              trattamento o prescritto dalla legge, sia a mezzo del ns. sistema informatico, ed in tal
              caso verranno registrati su supporti informatici protetti.
            </p>

            <h3 class="text-base font-bold mb-2">4) Natura del conferimento dei dati e conseguenze del rifiuto di rispondere</h3>
            <p class="mb-4">
              Si informa che, tenuto conto delle finalità del trattamento come sopra illustrate, per le
              finalità indicate dal punto 2.1) al punto 2.4) il conferimento dei dati è obbligatorio ed
              il loro mancato, parziale o inesatto conferimento potrà avere, come conseguenza,
              l'impossibilità di svolgere l'attività stessa e ci preclude di assolvere gli adempimenti
              contrattuali come previsti dal contratto di mandato. Per le finalità relative ai punti 2.5
              e 2.6) il conferimento dei dati è facoltativo, ed il loro mancato conferimento non
              preclude il rapporto in essere.
            </p>

            <h3 class="text-base font-bold mb-2">5) Comunicazioni</h3>
            <p class="mb-2">I Dati raccolti ed elaborati potranno essere:</p>
            <ul class="list-disc pl-6 mb-4 space-y-1">
              <li>messi a disposizione dei dipendenti e collaboratori del Titolare, in qualità di
              Responsabili o Incaricati al trattamento;</li>
              <li>A persone, società, associazioni o studi professionali che prestino servizi o
              attività di assistenza e consulenza a favore della Società al fine di tutelare un
              proprio diritto (ad esempio, commercialisti, avvocati, consulenti fiscali, revisori
              contabili, consulenti nell'ambito di operazioni di auditing o due diligence, etc.);
              Tali soggetti opereranno in qualità di Responsabili esterni del trattamento
              impartendo loro adeguate istruzioni operative;</li>
              <li>A fornitori della società e, in particolare, ai fornitori di servizi turistici inclusi
              nei pacchetti venduti;</li>
              <li>Alle Compagnie di assicurazione che prestano le coperture accessorie e collegate
              con i pacchetti e servizi turistici acquistati;</li>
              <li>A soggetti cui la facoltà di accedere ai Suoi dati sia riconosciuta da disposizioni
              di legge e di normativa secondaria o da disposizioni impartite da Autorità a ciò
              legittimate dalla legge, fra cui le autorità aeroportuali, portuali, doganali e di
              frontiera.</li>
            </ul>
            <p class="mb-4 text-sm">
              Nella sede legale è disponibile l'elenco completo ed aggiornato dei soggetti ai quali
              i dati possono essere comunicati.
            </p>

            <h3 class="text-base font-bold mb-2">6) Tempi di conservazione dei dati e altre informazioni</h3>
            <p class="mb-4">
              Il Titolare tratterà i dati personali per il tempo necessario per poter adempiere alle
              finalità di cui sopra e comunque per non oltre 10 anni dalla cessazione del rapporto
              per le Finalità di tenuta documenti contabili e fiscali come da legislazione vigente;
              mentre i dati per le Finalità soggette a consenso esplicito fino alla revoca del
              consenso espresso. Si informa inoltre che tutti i dati raccolti non saranno comunque
              oggetto di alcun processo decisionale automatizzato, compresa la profilazione.
            </p>

            <h3 class="text-base font-bold mb-2">7) Diritti dell'interessato</h3>
            <p class="mb-2">
              La informiamo inoltre che, in qualità di Interessato, ai sensi degli articoli da 15 a
              23 del GDPR, Le conferisce i seguenti specifici diritti:
            </p>
            <ul class="list-disc pl-6 mb-4 space-y-1">
              <li>Chiedere ed ottenere l'indicazione dell'origine dei dati personali, delle finalità e
              modalità del trattamento nonché della logica applicata, degli estremi
              identificativi del titolare e dei responsabili, dei soggetti o delle categorie
              di soggetti ai quali i dati personali possono essere comunicati o che possono
              venirne a conoscenza;</li>
              <li>Ottenere l'aggiornamento, la rettificazione o l'integrazione dei dati, la
              cancellazione, la trasformazione in forma anonima o il blocco dei dati trattati in
              violazione di legge, l'attestazione che tali operazioni richieste sono state portate
              a conoscenza di coloro ai quali i dati sono stati comunicati. Ove applicabili, ha
              altresì i diritti di cui agli artt. 16-21 del GDPR tra cui il Diritto di rettifica, diritto
              all'oblio, diritto di limitazione di trattamento, diritto alla portabilità dei dati,
              diritto di opposizione, nonché il diritto di reclamo all'Autorità Garante per la
              protezione dei dati. L'interessato ha il diritto di revocare il proprio consenso in
              qualsiasi momento. La revoca del consenso non pregiudica la liceità del
              trattamento basata sul consenso prima della revoca.</li>
            </ul>
            
            <h4 class="text-sm font-bold mb-2">Modalità di esercizio dei diritti</h4>
            <p class="mb-4">
              Potrà in qualsiasi momento esercitare i suoi diritti inviando una comunicazione
              agli indirizzi e con le modalità sotto riportate:
            </p>

            <h3 class="text-base font-bold mb-2">8) Titolare del Trattamento</h3>
            <p class="mb-4">
              La informiamo che il Titolare del Trattamento dei dati è la scrivente "Le Monde
              srl, con sede legale in Via Liberazione, 150 – 63074 – San Benedetto del Tronto
              (AP),
              <br>
              Tel: (+39) 0735.751346 - Email: info@maeviaggi.it - PEC: maegroup@tdpec.it
            </p>
          </div>
        </div>
        <div class="flex justify-end p-6 border-t border-gray-200 flex-shrink-0">
          <button id="close-modal-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded">
            Chiudi
          </button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>